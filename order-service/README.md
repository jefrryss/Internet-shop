# Order Service (Microservice)

Микросервис управления заказами для интернет-магазина «Гоzон».
Отвечает за создание заказов, их хранение и асинхронное взаимодействие с сервисом оплат (Payment Service) через Apache Kafka.

---

## Архитектура и Паттерны

Сервис построен на языке Go с использованием принципов Clean Architecture (разделение на слои).

Ключевые особенности:
* **Transactional Outbox Pattern**: Гарантирует надежную отправку событий в Kafka. Заказ и запись о необходимости отправки сообщения сохраняются в БД в рамках одной транзакции.
* **Asynchronous Communication**: Оплата происходит в фоне. Сервис не блокирует пользователя, ожидая ответа от банка или сервиса оплат.
* **Idempotency & Retry**: Взаимодействие с Kafka настроено на обработку сбоев и повторных попыток.

---

## Структура проекта

Ниже описано, за что отвечает каждая папка и файл в проекте:

```text
order-service/
├── cmd/
│   └── main.go                  # Точка входа. Инициализация БД, Kafka, роутера и запуск сервера.
├── internal/
│   ├── domain/                  # Чистая бизнес-логика и модели данных.
│   │   └── order/
│   │       └── model.go         # Go-структуры (Order, Event) и константы статусов. Не зависит от БД.
│   ├── infrastructure/          # Реализация взаимодействия с внешним миром (БД, Kafka, HTTP).
│   │   ├── http/
│   │   │   └── handler.go       # Обработчики REST API (парсинг JSON, валидация, вызов бизнес-логики).
│   │   ├── messaging/           # Асинхронное взаимодействие.
│   │   │   ├── consumer.go      # Читает ответы от Payment Service (успех/неуспех) и обновляет статус заказа.
│   │   │   └── relay.go         # Outbox Worker. Фоновый процесс, который перекладывает события из БД в Kafka.
│   │   └── persistence/         # Слой работы с БД (PostgreSQL). Реализация репозиториев и транзакций.
│   └── repository/              # реалиализация репозиториев.
├── migrations/
│   └── 001_init.sql             # SQL-скрипты для создания таблиц (orders, outbox).
├── docker-compose.yml           # Оркестрация контейнеров .
├── Dockerfile                   # Инструкция сборки Docker-образа сервиса.
├── go.mod / go.sum              # Управление зависимостями Go.
└── swagger.yaml                 # Документация API.
```

## Как это работает (Workflow)

1.  **Создание заказа (HTTP -> DB):**
    * Клиент делает запрос `POST /orders`.
    * Сервис открывает транзакцию.
    * Сохраняет заказ в таблицу `orders` со статусом `PENDING`.
    * Сохраняет событие в таблицу `outbox` (topic: `pay-order`).
    * Коммитит транзакцию.

2.  **Отправка в Kafka (DB -> Relay -> Kafka):**
    * Фоновый процесс (`relay.go`) видит новую запись в `outbox`.
    * Отправляет сообщение в Kafka в топик `pay-order`.
    * После успешной отправки помечает запись в `outbox` как обработанную.

3.  **Получение результата (Kafka -> Consumer -> DB):**
    * Сервис оплат списывает деньги и шлет ответ в топик `payment-results`.
    * `consumer.go` в Order Service читает это сообщение.
    * Находит заказ в БД и обновляет его статус на `PAID` (или `FAILED`).

---

## Доступные эндпоинты

Сервис запускается на порту **8081**.

| Метод | Путь | Описание |
| :--- | :--- | :--- |
| `POST` | `/orders` | Создать новый заказ (требует Header `X-User-Id`) |
| `GET` | `/orders` | Получить список заказов пользователя |
| `GET` | `/orders/{id}` | Получить статус конкретного заказа |